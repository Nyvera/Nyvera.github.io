<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nyvera - AI Chat with WebLLM</title>
<meta name="description" content="Nyvera is a progressive web app that lets you chat with AI models powered by WebLLM. Works offline with text and image generation capabilities." />
<meta name="keywords" content="AI, chat, WebLLM, PWA, offline, machine learning, image generation" />
<meta name="author" content="Nyvera" />
<meta name="theme-color" content="#7c3aed" />
<meta name="referrer" content="no-referrer-when-downgrade" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:title" content="Nyvera - AI Chat with WebLLM" />
<meta property="og:description" content="Chat with AI models powered by WebLLM. Works offline with text and image generation." />
<meta property="og:image" content="/web-app-manifest-512x512.png" />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Nyvera - AI Chat with WebLLM" />
<meta name="twitter:description" content="Chat with AI models powered by WebLLM. Works offline with text and image generation." />
<meta name="twitter:image" content="/web-app-manifest-512x512.png" />

<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="Nyvera" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="manifest" href="manifest.json" />

<!-- Syntax Highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

<style>
:root {
  --muted: #94a3b8;
  --accent: #7c3aed;
  --glass-bg: rgba(255,255,255,0.08);
  --glass-border: rgba(255,255,255,0.18);
}

html,body {
  height:100%;
  margin:0;
  font-family: Inter, system-ui, Segoe UI, Roboto, 'Helvetica Neue', Arial;
  color:#e6eef8;
  overflow:hidden;
}

/* Animated gradient background */
body {
  background:linear-gradient(270deg,#071129,#00121a,#1a1f3c,#002b40);
  background-size:800% 800%;
  animation: gradientShift 24s ease infinite;
  position:relative;
}
@keyframes gradientShift {
  0% { background-position:0% 50%; }
  50% { background-position:100% 50%; }
  100% { background-position:0% 50%; }
}

/* Canvas for particles */
canvas#stars {
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  z-index:0;
  pointer-events:none;
}

/* Cursor follower */
.cursor-follower {
  position: fixed;
  top: 0; left: 0;
  width: 40px; height: 40px;
  border-radius: 50%;
  pointer-events: none;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(8px);
  box-shadow: 0 0 20px rgba(255,255,255,0.6);
  transform: translate(-50%, -50%);
  z-index: 9999;
}

/* Layout */
.wrap {
  max-width:900px;
  margin:28px auto;
  padding:20px;
  display:flex;
  flex-direction:column;
  height:95vh;
  position:relative;
  z-index:1;
}
header {
  display:flex;
  gap:16px;
  align-items:center;
}
h1 {
  font-size:20px;
  margin:0;
}

/* Glass card */
.card {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:18px;
  border-radius:20px;
  background:var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border:1px solid var(--glass-border);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
  transition: background 0.3s, transform 0.3s;
}
.card:hover { background:rgba(255,255,255,0.12); transform:translateY(-2px); }

/* Inputs & text areas */
select,input[type=text],textarea {
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.25);
  background:rgba(255,255,255,0.08);
  backdrop-filter: blur(12px) saturate(150%);
  -webkit-backdrop-filter: blur(12px) saturate(150%);
  color:#e6eef8;
  transition:all 0.3s ease;
}
select:focus,input[type=text]:focus,textarea:focus {
  border:1px solid var(--accent);
  outline:none;
  background:rgba(255,255,255,0.15);
  box-shadow:0 0 10px rgba(124,58,237,0.5);
}

/* Buttons */
button {
  padding:10px 16px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.25);
  background:linear-gradient(135deg,var(--accent),#60a5fa);
  color:white;
  cursor:pointer;
  font-weight:500;
  backdrop-filter: blur(10px);
  transition:transform 0.2s, box-shadow 0.2s;
}
button:hover {
  transform:translateY(-2px) scale(1.02);
  box-shadow:0 6px 20px rgba(0,0,0,0.6), 0 0 12px rgba(124,58,237,0.6);
}

/* Progress bar */
.progress { height:10px; background:rgba(255,255,255,0.08); border-radius:8px; margin-top:8px; overflow:hidden; }
.progress>i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#7c3aed,#60a5fa); transition:width 0.4s ease; }

/* Chat */
.chat { flex:1; margin-top:18px; display:flex; flex-direction:column; gap:10px; overflow:auto; padding:8px; }
.msg {
  max-width:78%;
  padding:12px 14px;
  border-radius:16px;
  white-space:pre-wrap;
  backdrop-filter: blur(14px) saturate(160%);
  -webkit-backdrop-filter: blur(14px) saturate(160%);
  box-shadow:0 4px 14px rgba(0,0,0,0.45);
  transition:background 0.3s ease;
  position: relative;
}
.msg.user {
  align-self:flex-end;
  background:rgba(124,58,237,0.25);
  border:1px solid rgba(124,58,237,0.4);
  color:#e6e6ff;
}
.msg.ai {
  align-self:flex-start;
  background:rgba(15,23,36,0.55);
  border:1px solid rgba(255,255,255,0.18);
  color:#dcecff;
}
.msg.ai pre {
  background: rgba(0,0,0,0.3);
  padding: 12px;
  border-radius: 8px;
  overflow-x: auto;
  margin: 8px 0;
}
.msg.ai code {
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}
.msg.ai p {
  margin: 8px 0;
}
.copy-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  padding: 4px 8px;
  font-size: 11px;
  background: rgba(124,58,237,0.6);
  border: 1px solid rgba(124,58,237,0.8);
  border-radius: 6px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}
.msg:hover .copy-btn {
  opacity: 1;
}

footer { display:flex; gap:8px; margin-top:12px; }
textarea { resize: vertical; min-height: 60px; }
.meta { margin-top:8px; color:var(--muted); font-size:13px; }
.help { margin-top:10px; color:#cfe8ff; font-size:13px; }
.error { color:#ffb4b4; font-size:13px; margin-top:8px; }
.small { font-size:12px; color:var(--muted); }

#showTutorialBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 100000;
  padding: 10px 16px;
  border-radius: 16px;
  border: none;
  background: linear-gradient(135deg,var(--accent),#60a5fa);
  color:white;
  cursor:pointer;
  font-weight:500;
  box-shadow:0 4px 14px rgba(0,0,0,0.5);
}

/* Loading spinner */
.loading-spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Improved mobile responsiveness */
@media(max-width:600px) {
  .wrap { padding:10px; margin:10px auto; height:98vh; }
  .card { padding:12px; }
  h1 { font-size:18px; }
  .msg { max-width:85%; font-size:14px; padding:10px 12px; }
  button { padding:8px 12px; font-size:14px; }
  select { font-size:14px; }
  textarea { font-size:14px; min-height: 50px; }
  footer { flex-wrap: wrap; }
  #showTutorialBtn { bottom:10px; right:10px; padding:8px 12px; font-size:13px; }
  .copy-btn { font-size:10px; padding:3px 6px; }
}

@media(max-width:400px) {
  .wrap { padding:5px; }
  .card { padding:8px; }
  h1 { font-size:16px; }
  header { gap:10px; }
  header > div:first-child { width:42px; height:42px; font-size:14px; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

</head>
<body>

<!-- Cursor follower -->
<div class="cursor-follower"></div>

<!-- Particle canvas -->
<canvas id="stars"></canvas>

<div class="wrap">
  <header>
    <div style="width:52px;height:52px;border-radius:16px;background:linear-gradient(90deg,#7c3aed,#60a5fa);display:flex;align-items:center;justify-content:center;color:#04233b;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.5);backdrop-filter:blur(10px)">AI</div>
    <div>
      <h1>Nyvera</h1>
      <div class="meta">Now supports text & image generation.</div>
    </div>
  </header>

  <div class="card">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <label style="color:var(--muted)" for="modelSelect">Model:</label>
      <select id="modelSelect" aria-label="Select AI model"></select>
      <button id="loadBtn" aria-label="Load selected model">Load model</button>
      <button id="refreshModelsBtn" title="Re-read built-in model list" aria-label="Refresh model list">Refresh</button>
      <button id="clearChatBtn" title="Clear chat history" aria-label="Clear chat" style="background:rgba(239,68,68,0.8)">Clear Chat</button>
      <button id="exportChatBtn" title="Export chat history as text" aria-label="Export chat" style="background:rgba(34,197,94,0.8)">Export</button>
      <div style="flex:1"></div>
      <div style="font-size:12px;color:var(--muted)" role="status" aria-live="polite">Status: <span id="status">idle</span></div>
    </div>

    <div class="progress"><i id="progressBar"></i></div>
    <div id="availableModels" class="help small"></div>
    <div id="errorBox" class="error" style="display:none"></div>

    <div class="chat" id="chat"></div>

    <footer>
      <textarea id="prompt" placeholder="Type a message or /image something..." aria-label="Message input" rows="3"></textarea>
      <button id="sendBtn" aria-label="Send message">Send</button>
    </footer>
    <div class="small" style="margin-top:6px;text-align:center;color:var(--muted)">
      Tip: Press <kbd style="padding:2px 4px;background:rgba(255,255,255,0.1);border-radius:4px;">Ctrl+Enter</kbd> (or <kbd style="padding:2px 4px;background:rgba(255,255,255,0.1);border-radius:4px;">Cmd+Enter</kbd> on Mac) to send • Use <code style="background:rgba(255,255,255,0.1);padding:2px 4px;border-radius:4px;">/image</code> for image generation
    </div>
  </div>
</div>

<!-- Show tutorial button -->
<button id="showTutorialBtn">Show Tutorial</button>

<!-- Tutorial Overlay -->
<div id="tutorialOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:none;z-index:99999;">
  <div id="tutorialHighlight" style="position:absolute;border:2px solid var(--accent);border-radius:12px;box-shadow:0 0 20px var(--accent);pointer-events:none;transition:all 0.4s ease;"></div>
  <div id="tutorialBox" style="position:absolute;max-width:400px;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:20px;padding:20px;text-align:center;color:#e6eef8;z-index:99999;transition:all 0.4s ease;">
    <div id="tutorialStepContent" style="margin-bottom:20px;font-size:16px;"></div>
    <div style="display:flex;justify-content:space-between;">
      <button id="tutorialBackBtn">Back</button>
      <button id="tutorialNextBtn">Next</button>
    </div>
    <label style="display:block;margin-top:10px;font-size:12px;color:var(--muted)">
      <input type="checkbox" id="tutorialDontShow"/> Don't show this again
    </label>
    <button id="tutorialCloseBtn" style="position:absolute;top:10px;right:10px;background:rgba(255,0,0,0.6);border:none;padding:6px 10px;border-radius:10px;color:white;">X</button>
  </div>
</div>

<!-- AI & WebLLM Scripts -->
<script type="module">
// ============================================================================
// Nyvera - AI Chat Application
// Powered by WebLLM for offline AI chat and Pollinations API for images
// ============================================================================

import * as webllm from "https://esm.run/@mlc-ai/web-llm";
const { CreateMLCEngine, prebuiltAppConfig } = webllm;

// ============================================================================
// DOM Element References
// ============================================================================
const statusEl=document.getElementById('status');
const progressBar=document.getElementById('progressBar');
const chatEl=document.getElementById('chat');
const modelSelect=document.getElementById('modelSelect');
const loadBtn=document.getElementById('loadBtn');
const refreshBtn=document.getElementById('refreshModelsBtn');
const clearChatBtn=document.getElementById('clearChatBtn');
const sendBtn=document.getElementById('sendBtn');
const promptEl=document.getElementById('prompt');
const availableModelsEl=document.getElementById('availableModels');
const errorBox=document.getElementById('errorBox');

// ============================================================================
// Application State
// ============================================================================
let engine=null;
let messagesHistory=[];

// ============================================================================
// Chat History Management
// ============================================================================

// Load chat history from localStorage
function loadChatHistory() {
  try {
    const saved = localStorage.getItem('nyveraChatHistory');
    if (saved) {
      const history = JSON.parse(saved);
      history.forEach(msg => {
        if (msg.role === 'user') {
          appendMessage('user', msg.content, false);
        } else if (msg.role === 'assistant') {
          appendMessage('ai', msg.content, false);
        }
      });
      messagesHistory = history;
    }
  } catch (e) {
    console.error('Failed to load chat history:', e);
  }
}

// Save chat history to localStorage
function saveChatHistory() {
  try {
    localStorage.setItem('nyveraChatHistory', JSON.stringify(messagesHistory));
  } catch (e) {
    console.error('Failed to save chat history:', e);
  }
}

// Export chat history as text file
function exportChat() {
  if (messagesHistory.length === 0) {
    setStatus('No chat history to export');
    setTimeout(() => setStatus('idle'), 2000);
    return;
  }
  
  let chatText = 'Nyvera Chat History\n';
  chatText += '='.repeat(50) + '\n';
  chatText += `Exported: ${new Date().toLocaleString()}\n`;
  chatText += '='.repeat(50) + '\n\n';
  
  messagesHistory.forEach(msg => {
    const role = msg.role === 'user' ? 'You' : 'AI';
    chatText += `${role}:\n${msg.content}\n\n${'-'.repeat(50)}\n\n`;
  });
  
  // Create and download file
  const blob = new Blob([chatText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyvera-chat-${Date.now()}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  setStatus('Chat exported successfully');
  setTimeout(() => setStatus('ready'), 2000);
}

// Clear chat history
function clearChat() {
  if (confirm('Are you sure you want to clear the chat history?')) {
    chatEl.innerHTML = '';
    messagesHistory = [];
    localStorage.removeItem('nyveraChatHistory');
    setStatus('Chat cleared');
  }
}

// ============================================================================
// UI Helper Functions
// ============================================================================

function renderAIText(text){
  const processed=text.replace(/<think>(.*?)<\/think>/gs,"*$1*");
  const html=marked.parse(processed,{breaks:true});
  const container=document.createElement("div");container.innerHTML=html;
  container.querySelectorAll("pre code").forEach(el=>hljs.highlightElement(el));
  return container.innerHTML;
}

function copyToClipboard(text) {
  // Remove HTML tags for plain text copy
  const temp = document.createElement('div');
  temp.innerHTML = text;
  const plainText = temp.textContent || temp.innerText || '';
  
  navigator.clipboard.writeText(plainText).then(() => {
    setStatus('Copied to clipboard!');
    setTimeout(() => setStatus('ready'), 2000);
  }).catch(err => {
    console.error('Failed to copy:', err);
  });
}

function appendMessage(who, text, save = true){
  const div=document.createElement('div');
  div.className='msg '+(who==='user'?'user':'ai');
  
  if (who === 'ai') {
    div.innerHTML = renderAIText(text);
    // Add copy button for AI messages
    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.textContent = 'Copy';
    copyBtn.onclick = () => copyToClipboard(text);
    div.appendChild(copyBtn);
  } else {
    div.textContent = text;
  }
  
  chatEl.appendChild(div);
  chatEl.scrollTop=chatEl.scrollHeight;
  
  // Save to history if needed
  if (save) {
    saveChatHistory();
  }
}

// ============================================================================
// Model Management Functions
// ============================================================================

function setStatus(s){
  statusEl.innerHTML = s;
  // Add spinner for loading states
  if (s.includes('loading') || s.includes('generating') || s.includes('initializing')) {
    statusEl.innerHTML = `<span class="loading-spinner"></span> ${s}`;
  }
}

function setProgress(p){progressBar.style.width=Math.max(0,Math.min(100,p))+'%';}

function populateModelSelect(){
  modelSelect.innerHTML='';errorBox.style.display='none';
  const list=(prebuiltAppConfig&&prebuiltAppConfig.model_list)?prebuiltAppConfig.model_list:[];
  if(list.length===0){
    const fallback=[{id:'SmolLM2-1.7B-Instruct-q0f16',label:'SmolLM2-1.7B-Instruct'},{id:'Llama-3.1-8B-Instruct',label:'Llama-3.1-8B-Instruct'},{id:'Qwen-1.5B',label:'Qwen-1.5B'}];
    fallback.forEach(f=>{const opt=document.createElement('option');opt.value=f.id;opt.text=f.label||f.id;modelSelect.appendChild(opt);});
    availableModelsEl.innerText='Warning: no prebuilt models available.';return;
  }
  list.forEach(m=>{const id=m.model_id||m.model||m.name;if(!id) return;
    const opt=document.createElement('option');opt.value=id;opt.text=(m.short_name||m.name||id)+(m.vram_required_MB?` (VRAM ${m.vram_required_MB} MB)`: '');modelSelect.appendChild(opt);});
  availableModelsEl.innerText=`Detected ${list.length} built-in models.`;}
async function loadModel(){
  const modelId=modelSelect.value;setStatus('initializing engine');setProgress(0);errorBox.style.display='none';
  try{
    const initProgressCallback=(progress)=>{let frac=0;if(typeof progress==='number') frac=progress; else if(progress?.progress) frac=progress.progress;
      if(frac>1){setProgress(frac);setStatus('loading model: '+Math.round(frac)+'%');} else {setProgress(frac*100);setStatus('loading model: '+Math.round(frac*100)+'%');}};
    const opts={initProgressCallback}; if(prebuiltAppConfig) opts.appConfig=prebuiltAppConfig;
    engine=await CreateMLCEngine(modelId,opts); setStatus('ready ('+modelId+')'); setProgress(100);
  }catch(err){console.error(err);setStatus('error');errorBox.style.display='block';errorBox.innerText='Error loading model: '+(err?.message||err);}
}

// ============================================================================
// Image Generation Functions
// ============================================================================

async function sendImage(prompt) {
  appendMessage('user', '/image ' + prompt);
  setStatus('generating image...');

  try {
    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;

    const aiDiv = document.createElement('div');
    aiDiv.className = 'msg ai';
    aiDiv.innerHTML = `<div>Generating image...</div>`;
    chatEl.appendChild(aiDiv);
    chatEl.scrollTop = chatEl.scrollHeight;

    const img = new Image();
    img.src = url;
    img.alt = prompt;
    img.style.maxWidth = "100%";
    img.style.borderRadius = "12px";
    img.onload = () => {
      aiDiv.innerHTML = '';
      aiDiv.appendChild(img);
      setStatus('ready');
    };
    img.onerror = () => {
      aiDiv.innerHTML = '❌ Error generating image.';
      setStatus('error');
    };

    messagesHistory.push({ role: "assistant", content: `[Image generated for: ${prompt}]` });
  } catch (err) {
    console.error(err);
    appendMessage('ai', 'Error fetching image: ' + err.message);
    setStatus('error');
  }
}

// ============================================================================
// Text Chat Functions
// ============================================================================

async function sendMessage() {
  const text=promptEl.value.trim();
  if (!text) {
    setStatus('Please enter a message');
    setTimeout(() => setStatus('idle'), 2000);
    return;
  }
  promptEl.value = '';

  // Check for image command
  if (text.toLowerCase().startsWith('/image ')) {
    const imgPrompt = text.replace(/^\/image\s+/i, '').trim();
    if (!imgPrompt) {
      setStatus('Please provide an image prompt');
      setTimeout(() => setStatus('idle'), 2000);
      return;
    }
    return sendImage(imgPrompt);
  }

  if (!engine) {
    setStatus('Please load a model first');
    setTimeout(() => setStatus('idle'), 2000);
    return;
  }
  
  appendMessage('user', text);
  messagesHistory.push({role:'user',content:text});
  setStatus('generating...');
  
  const aiDiv=document.createElement('div');
  aiDiv.className='msg ai';
  aiDiv.innerHTML='<span class="loading-spinner"></span> Thinking...';
  chatEl.appendChild(aiDiv);
  chatEl.scrollTop=chatEl.scrollHeight;

  let partial='';
  try{
    const stream=await engine.chat.completions.create({messages:messagesHistory,temperature:0.7,stream:true});
    for await(const chunk of stream){
      const delta=chunk?.choices?.[0]?.delta?.content||'';
      if(delta){partial+=delta;aiDiv.innerHTML=renderAIText(partial);chatEl.scrollTop=chatEl.scrollHeight;}
    }
    // Add copy button after generation completes
    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.textContent = 'Copy';
    copyBtn.onclick = () => copyToClipboard(partial);
    aiDiv.appendChild(copyBtn);
    
    messagesHistory.push({role:'assistant',content:partial}); 
    saveChatHistory();
    setStatus('ready');
  }catch(err){console.error(err);appendMessage('ai','Error: '+(err?.message||err));setStatus('error');}
}

// ============================================================================
// Event Listeners and Initialization
// ============================================================================

loadBtn.addEventListener('click',loadModel);
sendBtn.addEventListener('click',sendMessage);
refreshBtn.addEventListener('click',populateModelSelect);
clearChatBtn.addEventListener('click',clearChat);
const exportChatBtn=document.getElementById('exportChatBtn');
exportChatBtn.addEventListener('click',exportChat);
promptEl.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey&&(e.ctrlKey||e.metaKey)) {
    e.preventDefault();
    sendMessage();
  }
});

// Add focus to prompt on load
window.addEventListener('load', () => {
  promptEl.focus();
});

// Disable buttons during model loading
loadBtn.addEventListener('click', async () => {
  loadBtn.disabled = true;
  modelSelect.disabled = true;
  try {
    await loadModel();
  } finally {
    loadBtn.disabled = false;
    modelSelect.disabled = false;
  }
});

// Better WebGPU detection
if(!('gpu' in navigator)) {
  setStatus('WARNING: WebGPU not available');
  errorBox.style.display='block';
  errorBox.innerHTML='WebGPU is not available in this browser. Please use Chrome/Edge 113+ or check if WebGPU is enabled in your browser flags.';
} else {
  setStatus('idle');
}

populateModelSelect();
loadChatHistory(); // Load saved chat history on startup
if("serviceWorker" in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(reg=>console.log("SW registered:",reg.scope)).catch(err=>console.error("SW registration failed:",err));});}
</script>

<!-- Particle starfield -->
<script>
const canvas=document.getElementById("stars");
const ctx=canvas.getContext("2d");
let w,h,particles=[];
function resize(){w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;}
window.addEventListener("resize",resize);resize();

class Particle{
  constructor(){this.reset();}
  reset(){this.x=Math.random()*w;this.y=Math.random()*h;this.r=Math.random()*1.8+0.2;this.dx=(Math.random()-0.5)*0.3;this.dy=(Math.random()-0.5)*0.3;this.alpha=Math.random()*0.5+0.5;}
  update(){this.x+=this.dx; this.y+=this.dy; if(this.x<0||this.x>w||this.y<0||this.y>h)this.reset(); this.alpha+=(Math.random()-0.5)*0.05; this.alpha=Math.min(1,Math.max(0.2,this.alpha));}
  draw(){ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fillStyle="rgba(255,255,255,"+this.alpha+")"; ctx.fill();}
}
function initParticles(num=150){particles=[];for(let i=0;i<num;i++){particles.push(new Particle());}}
function animate(){ctx.clearRect(0,0,w,h);particles.forEach(p=>{p.update();p.draw();}); requestAnimationFrame(animate);}
initParticles();animate();
</script>

<!-- Cursor follower -->
<script>
const follower = document.querySelector('.cursor-follower');
let mouseX = 0, mouseY = 0, posX = 0, posY = 0, speed = 0.1;
document.addEventListener('mousemove', e=>{mouseX=e.clientX; mouseY=e.clientY;});
function animateFollower(){ posX+=(mouseX-posX)*speed; posY+=(mouseY-posY)*speed; follower.style.left=posX+'px'; follower.style.top=posY+'px'; requestAnimationFrame(animateFollower);}
animateFollower();
</script>

<!-- Tutorial Script -->
<script>
const tutorialOverlay = document.getElementById('tutorialOverlay');
const tutorialBox = document.getElementById('tutorialBox');
const tutorialContent = document.getElementById('tutorialStepContent');
const highlight = document.getElementById('tutorialHighlight');
const nextBtn = document.getElementById('tutorialNextBtn');
const backBtn = document.getElementById('tutorialBackBtn');
const closeBtn = document.getElementById('tutorialCloseBtn');
const dontShowCheckbox = document.getElementById('tutorialDontShow');
const showTutorialBtn = document.getElementById('showTutorialBtn');

const tutorialSteps = [
  { text: "Welcome to Nyvera! Let's go through the main features.", element: null },
  { text: "Step 1: Select a model from the dropdown at the top. The second model from the top is usually the fastest.", element: "#modelSelect" },
  { text: "Step 2: Click 'Load model' to initialize the AI engine.", element: "#loadBtn" },
  { text: "Step 3: Type your message in the chat box and press 'Send' or Ctrl+Enter.", element: "#prompt" },
  { text: "Step 4: Generate images using '/image your prompt here'.", element: "#sendBtn" },
  { text: "Step 5: Monitor the status and progress bar to see model loading and generation.", element: "#progressBar" },
  { text: "You're all set! Enjoy using Nyvera.", element: null }
];

let currentStep = 0;

function showStep(index){
  if(index < 0) index = 0;
  if(index >= tutorialSteps.length) index = tutorialSteps.length - 1;
  currentStep = index;

  const step = tutorialSteps[index];
  tutorialContent.innerText = step.text;
  backBtn.style.display = index === 0 ? 'none' : 'inline-block';
  nextBtn.innerText = index === tutorialSteps.length - 1 ? 'Finish' : 'Next';

  if(step.element){
    const el = document.querySelector(step.element);
    if(el){
      const rect = el.getBoundingClientRect();
      highlight.style.display = 'block';
      highlight.style.width = rect.width + 12 + 'px';
      highlight.style.height = rect.height + 12 + 'px';
      highlight.style.top = rect.top - 6 + 'px';
      highlight.style.left = rect.left - 6 + 'px';

      let top = rect.bottom + 10;
      let left = rect.left;
      if(top + 160 > window.innerHeight) top = rect.top - 170;
      if(left + 400 > window.innerWidth) left = window.innerWidth - 420;
      tutorialBox.style.top = top + 'px';
      tutorialBox.style.left = left + 'px';
      tutorialBox.style.transform = 'translate(0,0)';
    } else {
      resetBoxCenter();
    }
  } else {
    resetBoxCenter();
  }
}

function resetBoxCenter(){
  highlight.style.display = 'none';
  tutorialBox.style.top = '50%';
  tutorialBox.style.left = '50%';
  tutorialBox.style.transform = 'translate(-50%,-50%)';
}

nextBtn.addEventListener('click',()=>{
  if(currentStep === tutorialSteps.length - 1){
    if(dontShowCheckbox.checked) localStorage.setItem('nyveraTutorialDismissed','true');
    tutorialOverlay.style.display = 'none';
  } else {
    showStep(currentStep + 1);
  }
});
backBtn.addEventListener('click',()=>showStep(currentStep - 1));
closeBtn.addEventListener('click',()=>{
  if(dontShowCheckbox.checked) localStorage.setItem('nyveraTutorialDismissed','true');
  tutorialOverlay.style.display='none';
});
showTutorialBtn.addEventListener('click',()=>{
  tutorialOverlay.style.display='block';
  showStep(0);
});

window.addEventListener('load',()=>{
  if(localStorage.getItem('nyveraTutorialDismissed')!=='true'){
    tutorialOverlay.style.display='block';
    showStep(0);
  }
});
</script>

</body>
</html>
