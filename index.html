<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrisimAI - Mistral</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
</head>
<body class="bg-gray-100 transition-colors duration-300">

<div id="loginScreen" class="flex items-center justify-center h-screen w-screen bg-gray-200">
  <div class="p-6 bg-white rounded shadow-lg">
    <h2 class="text-xl font-bold mb-4">Login</h2>
    <input id="username" placeholder="Username" class="border p-1 mb-2 w-full"/>
    <input id="password" type="password" placeholder="Password" class="border p-1 mb-2 w-full"/>
    <button id="loginBtn" class="px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 w-full">Login</button>
    <div id="loginMsg" class="text-red-500 mt-2"></div>
  </div>
</div>

<div id="mainUI" class="hidden flex h-screen overflow-hidden">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-72 bg-white/70 backdrop-blur-md p-4 flex flex-col transition-all duration-300">
    <button id="toggleSidebar" class="mb-4 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Collapse</button>
    <h2 class="font-bold text-lg mb-2">Models</h2>
    <select id="modelDropdown" class="mb-2 p-1 rounded border"></select>
    <div id="modelTiles" class="grid grid-cols-1 gap-2 mb-4 overflow-y-auto"></div>
    <h2 class="font-bold text-lg mb-2">Chat History</h2>
    <div id="chatHistory" class="flex-1 overflow-y-auto"></div>
    <button id="settingsBtn" class="mt-4 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Settings</button>
  </aside>

  <!-- Chat Area -->
  <main class="flex-1 flex flex-col bg-white/60 backdrop-blur-md p-4 relative">
    <div id="messages" class="flex-1 overflow-y-auto mb-4 space-y-2"></div>
    <div id="typingIndicator" class="hidden mb-2 flex items-center space-x-1">
      <span class="dot w-2 h-2 bg-gray-700 rounded-full animate-bounce"></span>
      <span class="dot w-2 h-2 bg-gray-700 rounded-full animate-bounce delay-150"></span>
      <span class="dot w-2 h-2 bg-gray-700 rounded-full animate-bounce delay-300"></span>
      <span>Model is typing...</span>
    </div>
    <div class="flex space-x-2">
      <input id="chatInput" type="text" placeholder="Type a message..." class="flex-1 p-2 border rounded"/>
      <input id="fileInput" type="file" class="hidden"/>
      <button id="attachBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Attach</button>
      <button id="sendBtn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Send</button>
      <button id="voiceBtn" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">üé§</button>
    </div>
  </main>
</div>

<!-- Settings Panel -->
<div id="settingsPanel" class="fixed top-0 right-0 w-80 h-full bg-white/80 backdrop-blur-md p-4 shadow-lg transform translate-x-full transition-transform duration-300">
  <h2 class="text-xl font-bold mb-4">Settings</h2>
  <div class="mb-4">
    <label class="block font-semibold mb-1">Theme:</label>
    <select id="themeSelect" class="p-1 border rounded w-full">
      <option value="light">Light</option>
      <option value="glass">Glassmorphic</option>
      <option value="dark">Dark</option>
    </select>
  </div>
  <div class="mb-4">
    <label class="block font-semibold mb-1">Voice Input/Output:</label>
    <input type="checkbox" id="voiceToggle" checked/> Enabled
  </div>
  <div class="mb-4">
    <label class="block font-semibold mb-1">Throttling Info:</label>
    <div id="throttleInfo" class="text-sm text-gray-700">No active throttles</div>
  </div>
  <button id="closeSettings" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Close</button>
</div>

<script>
const API_KEY = '8OtDWHGDeNs7rpQxRoYSSMjDjoP6utZr';
const API_URL = 'https://api.mistral.ai/v1/agents/completions';
const FREE_DELAY_MS = 10000; // 10s delay
const FREE_MAX_PER_HOUR = 20;

let isPremium = false;
let lastMessageTime = 0;
let messagesSent = 0;

const md = window.markdownit();
let currentModel = {id:'Mistral-8B', name:'Mistral-8B'};
const models = [currentModel];

let chatHistory = JSON.parse(localStorage.getItem('chatHistory')||'[]');

// ======= Elements =======
const loginScreen = document.getElementById('loginScreen');
const mainUI = document.getElementById('mainUI');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const sidebar = document.getElementById('sidebar');
const toggleSidebar = document.getElementById('toggleSidebar');
const modelDropdown = document.getElementById('modelDropdown');
const modelTiles = document.getElementById('modelTiles');
const chatHistoryDiv = document.getElementById('chatHistory');
const messagesDiv = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');
const voiceBtn = document.getElementById('voiceBtn');
const typingIndicator = document.getElementById('typingIndicator');
const settingsBtn = document.getElementById('settingsBtn');
const settingsPanel = document.getElementById('settingsPanel');
const closeSettings = document.getElementById('closeSettings');
const themeSelect = document.getElementById('themeSelect');
const voiceToggle = document.getElementById('voiceToggle');
const throttleInfo = document.getElementById('throttleInfo');

// ======= Functions =======
function saveHistory(){localStorage.setItem('chatHistory',JSON.stringify(chatHistory));}
function renderChat(){
  messagesDiv.innerHTML='';
  chatHistory.forEach(msg=>{
    const div=document.createElement('div');
    div.className='p-2 rounded '+(msg.role==='user'?'bg-blue-100 self-end':'bg-gray-200 self-start');
    div.innerHTML=md.render(msg.content);
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
function renderHistory(){
  chatHistoryDiv.innerHTML='';
  chatHistory.forEach((chat,idx)=>{
    const div=document.createElement('div');
    div.className='p-1 border-b cursor-pointer hover:bg-gray-100 flex justify-between';
    div.innerHTML=`<span>${chat.title||'Chat '+(idx+1)}</span>
      <span>
        <button onclick="deleteChat(${idx})">üóëÔ∏è</button>
        <button onclick="renameChat(${idx})">‚úèÔ∏è</button>
        <button onclick="starChat(${idx})">‚≠ê</button>
      </span>`;
    div.onclick=()=>loadChat(idx);
    chatHistoryDiv.appendChild(div);
  });
}
function loadChat(idx){
  chatHistory=[chatHistory[idx]];renderChat();
}
function deleteChat(idx){chatHistory.splice(idx,1);saveHistory();renderHistory();}
function renameChat(idx){const n=prompt("New name:",chatHistory[idx].title||"Chat");if(n){chatHistory[idx].title=n;saveHistory();renderHistory();}}
function starChat(idx){chatHistory[idx].starred=!chatHistory[idx].starred;saveHistory();renderHistory();}
function renderModels(){
  modelDropdown.innerHTML='';
  models.forEach((m,i)=>{const opt=document.createElement('option');opt.value=i;opt.textContent=m.name;modelDropdown.appendChild(opt);});
  modelTiles.innerHTML='';
  models.forEach((m,i)=>{
    const tile=document.createElement('div');
    tile.className='p-2 border rounded hover:bg-gray-100 cursor-pointer';
    tile.innerHTML=`<strong>${m.name}</strong>`;
    tile.onclick=()=>{currentModel=m;alert("Switched to "+m.name);}
    modelTiles.appendChild(tile);
  });
}
function addMessage(role,content){chatHistory.push({role,content});saveHistory();renderChat();}
function checkThrottle(){ 
  if(isPremium) return true;
  const now=Date.now();
  if(now-lastMessageTime<FREE_DELAY_MS) return false;
  if(messagesSent>=FREE_MAX_PER_HOUR){throttleInfo.textContent='Message limit reached!';return false;}
  return true;
}

// ======= Streaming =======
async function sendMessage(message){
  if(!checkThrottle()){alert('You are throttled or delayed!');return;}
  lastMessageTime=Date.now();messagesSent++;
  addMessage('user',message);
  typingIndicator.classList.remove('hidden');

  const body={
    agent_id: currentModel.id,
    messages:[{role:'user',content:message}],
    max_tokens:500,
    stream:true
  };
  const res = await fetch(API_URL,{
    method:'POST',
    headers:{
      'Authorization':'ApiKey '+API_KEY,
      'Content-Type':'application/json'
    },
    body: JSON.stringify(body)
  });
  if(!res.body){typingIndicator.classList.add('hidden');return;}
  const reader=res.body.getReader();
  const decoder=new TextDecoder();
  let done=false;
  let assistantDiv=document.createElement('div');
  assistantDiv.className='p-2 rounded bg-gray-200 self-start';
  messagesDiv.appendChild(assistantDiv);

  while(!done){
    const {value,done:doneReading}=await reader.read();
    done=doneReading;
    const chunk=decoder.decode(value);
    const lines=chunk.split('\n');
    lines.forEach(line=>{
      if(line.startsWith('data:')){
        const data=line.replace('data:','').trim();
        if(data==='[DONE]') done=true;
        else{
          try{
            const parsed=JSON.parse(data);
            if(parsed?.prediction?.content) assistantDiv.innerHTML+=md.render(parsed.prediction.content);
          }catch(e){}
        }
      }
    });
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  }
  typingIndicator.classList.add('hidden');
}

// ======= Event Listeners =======
loginBtn.onclick=()=>{
  const u=usernameInput.value.trim(),p=passwordInput.value.trim();
  if(u==='guest'&&p==='guest123'){isPremium=true;loginScreen.style.display='none';mainUI.classList.remove('hidden');} 
  else{loginMsg.textContent='Invalid credentials';}
}

toggleSidebar.onclick=()=>sidebar.classList.toggle('-translate-x-full');
modelDropdown.onchange=e=>currentModel=models[e.target.value];
sendBtn.onclick=()=>sendMessage(chatInput.value.trim());
attachBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=()=>addMessage('user',`![attachment](${reader.result})`);reader.readAsDataURL(file);}}
voiceBtn.onclick=()=>{
  if(!voiceToggle.checked) return alert("Voice disabled");
  const recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
  recognition.onresult=(event)=>{chatInput.value=event.results[0][0].transcript;}
  recognition.start();
}
settingsBtn.onclick=()=>settingsPanel.classList.remove('translate-x-full');
closeSettings.onclick=()=>settingsPanel.classList.add('translate-x-full');
themeSelect.onchange=()=>{
  document.body.className='';
  if(themeSelect.value==='dark') document.body.classList.add('bg-gray-800','text-white');
  else if(themeSelect.value==='glass') document.body.classList.add('bg-white/30','backdrop-blur-md');
  else document.body.classList.add('bg-gray-100');
}

// ======= Init =======
renderModels();renderHistory();renderChat();

</script>
</body>
</html>
