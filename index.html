<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrisimAI</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
</head>
<body class="bg-gray-100 transition-colors duration-300">

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow-lg w-80">
    <h2 class="text-xl font-bold mb-4">Login</h2>
    <input id="username" type="text" placeholder="Username" class="w-full p-2 mb-2 border rounded"/>
    <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-4 border rounded"/>
    <button id="loginBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
    <p id="loginError" class="text-red-500 mt-2 hidden">Invalid credentials</p>
  </div>
</div>

<div id="mainApp" class="flex h-screen overflow-hidden hidden">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-72 bg-white/70 backdrop-blur-md p-4 flex flex-col transition-all duration-300">
    <button id="toggleSidebar" class="mb-4 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Collapse</button>
    <h2 class="font-bold text-lg mb-2">Models</h2>
    <select id="modelDropdown" class="mb-2 p-1 rounded border"></select>
    <div id="modelTiles" class="grid grid-cols-1 gap-2 mb-4 overflow-y-auto"></div>
    <h2 class="font-bold text-lg mb-2">Chat History</h2>
    <div id="chatHistory" class="flex-1 overflow-y-auto"></div>
    <button id="settingsBtn" class="mt-4 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Settings</button>
  </aside>

  <!-- Chat Area -->
  <main class="flex-1 flex flex-col bg-white/60 backdrop-blur-md p-4 relative">
    <div id="messages" class="flex-1 overflow-y-auto mb-4 space-y-2"></div>
    <div id="typingIndicator" class="hidden mb-2 flex items-center space-x-1">
      <span class="dot w-2 h-2 bg-gray-700 rounded-full animate-bounce"></span>
      <span class="dot w-2 h-2 bg-gray-700 rounded-full animate-bounce delay-150"></span>
      <span class="dot w-2 h-2 bg-gray-700 rounded-full animate-bounce delay-300"></span>
      <span>Model is typing...</span>
    </div>
    <div class="flex space-x-2">
      <input id="chatInput" type="text" placeholder="Type a message..." class="flex-1 p-2 border rounded"/>
      <input id="fileInput" type="file" class="hidden"/>
      <button id="attachBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Attach</button>
      <button id="sendBtn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Send</button>
      <button id="voiceBtn" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">ðŸŽ¤</button>
    </div>
  </main>
</div>

<!-- Settings Panel -->
<div id="settingsPanel" class="fixed top-0 right-0 w-80 h-full bg-white/80 backdrop-blur-md p-4 shadow-lg transform translate-x-full transition-transform duration-300">
  <h2 class="text-xl font-bold mb-4">Settings</h2>
  <div class="mb-4">
    <label class="block font-semibold mb-1">Theme:</label>
    <select id="themeSelect" class="p-1 border rounded w-full">
      <option value="light">Light</option>
      <option value="glass">Glassmorphic</option>
      <option value="dark">Dark</option>
    </select>
  </div>
  <div class="mb-4">
    <label class="block font-semibold mb-1">Voice Input/Output:</label>
    <input type="checkbox" id="voiceToggle" checked/> Enabled
  </div>
  <div class="mb-4">
    <label class="block font-semibold mb-1">Throttling Info:</label>
    <div id="throttleInfo" class="text-sm text-gray-700">No active throttles</div>
  </div>
  <button id="closeSettings" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Close</button>
</div>

<script>
const md = window.markdownit();

// ======= Variables =======
const MISTRAL_KEY = "8OtDWHGDeNs7rpQxRoYSSMjDjoP6utZr";
const MODELS_URL = "https://api.mistral.ai/v1/models";
const CHAT_URL = "https://api.mistral.ai/v1/chat/completions";

let models = [];
let currentModel = null;
let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
let lastMessageTime = 0;
const FREE_DELAY = 3000;
const MAX_MSGS_PER_MIN = 5;
let msgCount = 0;
let isPremium = false;

// ======= Elements =======
const loginModal = document.getElementById('loginModal');
const mainApp = document.getElementById('mainApp');
const username = document.getElementById('username');
const password = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const sidebar = document.getElementById('sidebar');
const toggleSidebar = document.getElementById('toggleSidebar');
const modelDropdown = document.getElementById('modelDropdown');
const modelTiles = document.getElementById('modelTiles');
const chatHistoryDiv = document.getElementById('chatHistory');
const messagesDiv = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');
const voiceBtn = document.getElementById('voiceBtn');
const typingIndicator = document.getElementById('typingIndicator');
const settingsBtn = document.getElementById('settingsBtn');
const settingsPanel = document.getElementById('settingsPanel');
const closeSettings = document.getElementById('closeSettings');
const themeSelect = document.getElementById('themeSelect');
const voiceToggle = document.getElementById('voiceToggle');
const throttleInfo = document.getElementById('throttleInfo');

// ======= Login =======
loginBtn.onclick = ()=>{
  if(username.value === "guest" && password.value==="guest123"){
    isPremium = true;
    loginModal.classList.add('hidden');
    mainApp.classList.remove('hidden');
  } else {
    loginError.classList.remove('hidden');
  }
}

// ======= Utils =======
function saveHistory(){ localStorage.setItem('chatHistory', JSON.stringify(chatHistory)); }
function renderChat(){
  messagesDiv.innerHTML = '';
  chatHistory.forEach(msg=>{
    const div = document.createElement('div');
    div.className = 'p-2 rounded '+(msg.role==='user'?'bg-blue-100 self-end':'bg-gray-200 self-start');
    div.innerHTML = md.render(msg.content);
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
function addMessage(role, content){
  chatHistory.push({role, content});
  saveHistory();
  renderChat();
}

// ======= Throttling =======
function canSend(){
  if(isPremium) return true;
  const now = Date.now();
  if(now - lastMessageTime < FREE_DELAY) return false;
  if(msgCount >= MAX_MSGS_PER_MIN){
    throttleInfo.textContent = "Throttled: wait 1 minute";
    setTimeout(()=>{ msgCount=0; throttleInfo.textContent='No active throttles'; },60000);
    return false;
  }
  lastMessageTime = now;
  msgCount++;
  return true;
}

// ======= Fetch Models =======
async function fetchModels(){
  const res = await fetch(MODELS_URL,{headers:{'Authorization':'Bearer '+MISTRAL_KEY}});
  const data = await res.json();
  models = data.models || [];
  if(models.length>0) currentModel=models[0];
  renderModels();
}
function renderModels(){
  modelDropdown.innerHTML=''; modelTiles.innerHTML='';
  models.forEach((m,i)=>{
    const opt=document.createElement('option'); opt.value=i; opt.textContent=m.name;
    modelDropdown.appendChild(opt);
    const tile=document.createElement('div');
    tile.className='p-2 border rounded hover:bg-gray-100 cursor-pointer';
    tile.innerHTML=`<strong>${m.name}</strong><br/><small>${m.description||''}</small>`;
    tile.onclick = ()=>{ currentModel=m; alert("Switched to "+m.name);}
    modelTiles.appendChild(tile);
  });
}
modelDropdown.onchange = e=>{ currentModel=models[e.target.value]; }

// ======= Send Message =======
sendBtn.onclick = async ()=>{
  const msg = chatInput.value.trim();
  if(!msg) return;
  if(!canSend()) return;
  addMessage('user', msg);
  chatInput.value='';
  await sendToMistral(msg);
}

// ======= Attachments =======
attachBtn.onclick = ()=> fileInput.click();
fileInput.onchange = (e)=>{
  const file=e.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=()=> addMessage('user', `![attachment](${reader.result})`);
    reader.readAsDataURL(file);
  }
}

// ======= Voice Input =======
voiceBtn.onclick = ()=>{
  if(!voiceToggle.checked) return alert("Voice disabled");
  const recognition = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  recognition.onresult = e=>{ chatInput.value = e.results[0][0].transcript; }
  recognition.start();
}

// ======= Settings =======
toggleSidebar.onclick = ()=> sidebar.classList.toggle('-translate-x-full');
settingsBtn.onclick = ()=> settingsPanel.classList.remove('translate-x-full');
closeSettings.onclick = ()=> settingsPanel.classList.add('translate-x-full');
themeSelect.onchange = ()=>{
  document.body.className='';
  if(themeSelect.value==='dark') document.body.classList.add('bg-gray-800','text-white');
  else if(themeSelect.value==='glass') document.body.classList.add('bg-white/30','backdrop-blur-md');
  else document.body.classList.add('bg-gray-100');
}

// ======= Streaming Mistral =======
async function sendToMistral(message){
  if(!currentModel) return alert("No model selected");
  typingIndicator.classList.remove('hidden');
  const payload = {
    model: currentModel.name,
    input: message,
    max_output_tokens: 500
  };
  try{
    const res = await fetch(CHAT_URL,{
      method:'POST',
      headers:{
        'Authorization':'Bearer '+MISTRAL_KEY,
        'Content-Type':'application/json'
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    const output = data?.output?.[0]?.content || "No response";
    addMessage('assistant', output);
  }catch(e){ addMessage('assistant', 'Error: '+e.message);}
  typingIndicator.classList.add('hidden');
}

// ======= Init =======
fetchModels();
renderChat();
</script>
</body>
</html>
