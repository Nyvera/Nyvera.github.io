<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nyvera</title>
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="Nyvera" />
<link rel="manifest" href="manifest.json" />

<style>
:root {
  --muted: #94a3b8;
  --accent: #7c3aed;
  --glass-bg: rgba(255,255,255,0.08);
  --glass-border: rgba(255,255,255,0.18);
}

html,body {
  height:100%;
  margin:0;
  font-family: Inter, system-ui, Segoe UI, Roboto, 'Helvetica Neue', Arial;
  color:#e6eef8;
  overflow:hidden;
}

/* background gradient */
body {
  background:linear-gradient(270deg,#071129,#00121a,#1a1f3c,#002b40);
  background-size:800% 800%;
  animation: gradientShift 24s ease infinite;
  position:relative;
}
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
canvas#stars {
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  z-index:0;
  pointer-events:none;
}

/* wrapper */
.wrap {
  max-width:900px;
  margin:28px auto;
  padding:20px;
  display:flex;
  flex-direction:column;
  height:95vh;
  position:relative;
  z-index:1;
}
header {
  display:flex;
  gap:16px;
  align-items:center;
}
h1 { font-size:20px; margin:0; }

/* glass card */
.card {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:18px;
  border-radius:20px;
  background:var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border:1px solid var(--glass-border);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
  transition: background 0.3s, transform 0.3s;
}
.card:hover {
  background:rgba(255,255,255,0.12);
  transform:translateY(-2px);
}

/* inputs & text areas */
select,input[type=text],textarea {
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.25);
  background:rgba(255,255,255,0.08);
  backdrop-filter: blur(12px) saturate(150%);
  -webkit-backdrop-filter: blur(12px) saturate(150%);
  color:#e6eef8;
  transition:all 0.3s ease;
}
select:focus,input[type=text]:focus,textarea:focus {
  border:1px solid var(--accent);
  outline:none;
  background:rgba(255,255,255,0.15);
  box-shadow:0 0 10px rgba(124,58,237,0.5);
}

/* buttons */
button {
  padding:10px 16px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.25);
  background:linear-gradient(135deg,var(--accent),#60a5fa);
  color:white;
  cursor:pointer;
  font-weight:500;
  backdrop-filter: blur(10px);
  transition:transform 0.2s, box-shadow 0.2s;
}
button:hover {
  transform:translateY(-2px) scale(1.02);
  box-shadow:0 6px 20px rgba(0,0,0,0.6), 0 0 12px rgba(124,58,237,0.6);
}

/* progress */
.progress {
  height:10px;
  background:rgba(255,255,255,0.08);
  border-radius:8px;
  margin-top:8px;
  overflow:hidden;
}
.progress > i {
  display:block;
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#7c3aed,#60a5fa);
  transition: width 0.4s ease;
}

/* chat */
.chat {
  flex:1;
  margin-top:18px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow:auto;
  padding:8px;
}
.msg {
  max-width:78%;
  padding:12px 14px;
  border-radius:16px;
  white-space:pre-wrap;
  backdrop-filter: blur(14px) saturate(160%);
  -webkit-backdrop-filter: blur(14px) saturate(160%);
  box-shadow:0 4px 14px rgba(0,0,0,0.45);
  transition:background 0.3s ease;
}
.msg.user {
  align-self:flex-end;
  background:rgba(124,58,237,0.25);
  border:1px solid rgba(124,58,237,0.4);
  color:#e6e6ff;
}
.msg.ai {
  align-self:flex-start;
  background:rgba(15,23,36,0.55);
  border:1px solid rgba(255,255,255,0.18);
  color:#dcecff;
}

footer { display:flex; gap:8px; margin-top:12px; }
.meta { margin-top:8px; color:var(--muted); font-size:13px; }
.help { margin-top:10px; color:#cfe8ff; font-size:13px; }
.error { color:#ffb4b4; font-size:13px; margin-top:8px; }
.small { font-size:12px; color:var(--muted); }

/* cursor follower orb */
.cursor-follower {
  position: fixed;
  top:0; left:0;
  width: 40px;
  height: 40px;
  border-radius:50%;
  pointer-events:none;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(8px);
  box-shadow: 0 0 20px rgba(255,255,255,0.6);
  transform: translate(-50%, -50%);
  z-index:9999;
}
</style>

<!-- Markdown parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

</head>
<body>
  <!-- Particle canvas -->
  <canvas id="stars"></canvas>

  <!-- Cursor follower orb -->
  <div class="cursor-follower"></div>

  <div class="wrap">
    <header>
      <div style="width:52px;height:52px;border-radius:16px;background:linear-gradient(90deg,#7c3aed,#60a5fa);display:flex;align-items:center;justify-content:center;color:#04233b;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.5);backdrop-filter:blur(10px)">AI</div>
      <div>
        <h1>Nyvera</h1>
        <div class="meta">The AI now maintains conversation history so it actually responds correctly.</div>
      </div>
    </header>

    <div class="card">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label style="color:var(--muted)">Model:</label>
        <select id="modelSelect"></select>
        <button id="loadBtn">Load model</button>
        <button id="refreshModelsBtn" title="Re-read built-in model list">Refresh</button>
        <div style="flex:1"></div>
        <div style="font-size:12px;color:var(--muted)">Status: <span id="status">idle</span></div>
      </div>

      <div class="progress"><i id="progressBar"></i></div>
      <div id="availableModels" class="help small"></div>
      <div id="errorBox" class="error" style="display:none"></div>

      <div class="chat" id="chat"></div>

      <footer>
        <textarea id="prompt" placeholder="Type a message..."></textarea>
        <button id="sendBtn">Send</button>
      </footer>
    </div>
  </div>

<!-- WebLLM AI Script -->
<script type="module">
import * as webllm from "https://esm.run/@mlc-ai/web-llm";
const { CreateMLCEngine, prebuiltAppConfig } = webllm;

const statusEl=document.getElementById('status');
const progressBar=document.getElementById('progressBar');
const chatEl=document.getElementById('chat');
const modelSelect=document.getElementById('modelSelect');
const loadBtn=document.getElementById('loadBtn');
const refreshBtn=document.getElementById('refreshModelsBtn');
const sendBtn=document.getElementById('sendBtn');
const promptEl=document.getElementById('prompt');
const availableModelsEl=document.getElementById('availableModels');
const errorBox=document.getElementById('errorBox');
let engine=null;
let messagesHistory=[];

function renderAIText(text){
  const processed=text.replace(/<think>(.*?)<\/think>/gs,"*$1*");
  const html=marked.parse(processed,{breaks:true});
  const container=document.createElement("div");container.innerHTML=html;
  container.querySelectorAll("pre code").forEach(el=>hljs.highlightElement(el));
  return container.innerHTML;
}
function appendMessage(who,text){
  const div=document.createElement('div');
  div.className='msg '+(who==='user'?'user':'ai');
  div.innerHTML=(who==='ai')?renderAIText(text):text;
  chatEl.appendChild(div);
  chatEl.scrollTop=chatEl.scrollHeight;
}
function setStatus(s){statusEl.innerText=s;}
function setProgress(p){progressBar.style.width=Math.max(0,Math.min(100,p))+'%';}
function populateModelSelect(){
  modelSelect.innerHTML='';errorBox.style.display='none';
  const list=(prebuiltAppConfig&&prebuiltAppConfig.model_list)?prebuiltAppConfig.model_list:[];
  if(list.length===0){
    const fallback=[{id:'SmolLM2-1.7B-Instruct-q0f16',label:'SmolLM2-1.7B-Instruct'},{id:'Llama-3.1-8B-Instruct',label:'Llama-3.1-8B-Instruct'},{id:'Qwen-1.5B',label:'Qwen-1.5B'}];
    fallback.forEach(f=>{const opt=document.createElement('option');opt.value=f.id;opt.text=f.label||f.id;modelSelect.appendChild(opt);});
    availableModelsEl.innerText='Warning: no prebuilt models available.';return;
  }
  list.forEach(m=>{const id=m.model_id||m.model||m.name;if(!id) return;
    const opt=document.createElement('option');opt.value=id;opt.text=(m.short_name||m.name||id)+(m.vram_required_MB?` (VRAM ${m.vram_required_MB} MB)`: '');modelSelect.appendChild(opt);});
  availableModelsEl.innerText=`Detected ${list.length} built-in models.`;}
async function loadModel(){
  const modelId=modelSelect.value;setStatus('initializing engine');setProgress(0);errorBox.style.display='none';
  try{
    const initProgressCallback=(progress)=>{let frac=0;if(typeof progress==='number') frac=progress; else if(progress?.progress) frac=progress.progress;
      if(frac>1){setProgress(frac);setStatus('loading model: '+Math.round(frac)+'%');} else {setProgress(frac*100);setStatus('loading model: '+Math.round(frac*100)+'%');}};
    const opts={initProgressCallback}; if(prebuiltAppConfig) opts.appConfig=prebuiltAppConfig;
    engine=await CreateMLCEngine(modelId,opts); setStatus('ready ('+modelId+')'); setProgress(100);
  }catch(err){console.error(err);setStatus('error');errorBox.style.display='block';errorBox.innerText='Error loading model: '+(err?.message||err);}
}
async function sendMessage(){
  const text=promptEl.value.trim(); if(!text||!engine) return;
  promptEl.value=''; appendMessage('user',text); messagesHistory.push({role:'user',content:text}); setStatus('generating...');
  const aiDiv=document.createElement('div'); aiDiv.className='msg ai'; aiDiv.innerHTML=''; chatEl.appendChild(aiDiv); chatEl.scrollTop=chatEl.scrollHeight;
  let partial=''; try{const stream=await engine.chat.completions.create({messages:messagesHistory,temperature:0.7,stream:true});
    for await(const chunk of stream){const delta=chunk?.choices?.[0]?.delta?.content||''; if(delta){partial+=delta;aiDiv.innerHTML=renderAIText(partial);chatEl.scrollTop=chatEl.scrollHeight;}}
    messagesHistory.push({role:'assistant',content:partial}); setStatus('ready');
  }catch(err){console.error(err);appendMessage('ai','Error: '+(err?.message||err));setStatus('error');}
}
loadBtn.addEventListener('click',loadModel);
sendBtn.addEventListener('click',sendMessage);
refreshBtn.addEventListener('click',populateModelSelect);
promptEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)) sendMessage();});
if(!('gpu' in navigator)) setStatus('WARNING: WebGPU not available');
populateModelSelect();
if("serviceWorker" in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(reg=>console.log("SW registered:",reg.scope)).catch(err=>console.error("SW registration failed:",err));});}
</script>

<!-- Starfield -->
<script>
const canvas=document.getElementById("stars");
const ctx=canvas.getContext("2d");
let w,h,particles=[];
function resize(){w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;}
window.addEventListener("resize",resize);resize();
class Particle{
  constructor(){this.reset();}
  reset(){this.x=Math.random()*w;this.y=Math.random()*h;this.r=Math.random()*1.8+0.2;this.dx=(Math.random()-0.5)*0.3;this.dy=(Math.random()-0.5)*0.3;this.alpha=Math.random()*0.5+0.5;}
  update(){this.x+=this.dx;this.y+=this.dy;if(this.x<0||this.x>w||this.y<0||this.y>h) this.reset(); this.alpha+= (Math.random()-0.5)*0.05; if(this.alpha<0.2) this.alpha=0.2; if(this.alpha>1) this.alpha=1;}
  draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fillStyle="rgba(255,255,255,"+this.alpha+")";ctx.fill();}
}
function initParticles(num=150){particles=[];for(let i=0;i<num;i++){particles.push(new Particle());}}
function animate(){ctx.clearRect(0,0,w,h);particles.forEach(p=>{p.update();p.draw();});requestAnimationFrame(animate);}
initParticles();animate();
</script>

<!-- Cursor follower with trail -->
<script>
const follower = document.querySelector('.cursor-follower');
let mouseX = 0, mouseY = 0, posX = 0, posY = 0, speed = 0.15;
const trailCount = 20;
let trail = [];
for (let i = 0; i < trailCount; i++) trail.push({x:0, y:0, alpha:0});
const trailCanvas = document.createElement('canvas');
trailCanvas.style.position='fixed'; trailCanvas.style.top='0'; trailCanvas.style.left='0';
trailCanvas.style.width='100%'; trailCanvas.style.height='100%';
trailCanvas.style.pointerEvents='none'; trailCanvas.style.zIndex = '9998';
document.body.appendChild(trailCanvas);
const tctx = trailCanvas.getContext('2d');
function resizeTrail(){trailCanvas.width = window.innerWidth; trailCanvas.height = window.innerHeight;}
window.addEventListener('resize', resizeTrail); resizeTrail();
document.addEventListener('mousemove', e=>{mouseX=e.clientX; mouseY=e.clientY;});
document.addEventListener('mousedown', ()=>{
  follower.style.transition='width 0.1s, height 0.1s, box-shadow 0.1s';
  follower.style.width='60px'; follower.style.height='60px';
  follower.style.boxShadow='0 0 30px rgba(124,58,237,1),0 0 50px rgba(124,58,237,0.6)';
  setTimeout(()=>{follower.style.width='40px';follower.style.height='40px';follower.style.boxShadow='0 0 20px rgba(255,255,255,0.6)';},100);
});
function animateFollower(){
  posX += (mouseX - posX) * speed;
  posY += (mouseY - posY) * speed;
  follower.style.transform=`translate(${posX}px, ${posY}px) translate(-50%, -50%)`;
  trail.unshift({x:posX, y:posY, alpha:1});
  if(trail.length>trailCount) trail.pop();
  tctx.clearRect(0,0,trailCanvas.width, trailCanvas.height);
  trail.forEach((p,i)=>{
    tctx.beginPath(); tctx.arc(p.x,p.y,(trailCount-i)/4+4,0,Math.PI*2);
    tctx.fillStyle=`rgba(124,58,237,${p.alpha*0.4})`;
    tctx.fill();
    p.alpha*=0.85;
  });
  requestAnimationFrame(animateFollower);
}
animateFollower();
</script>
</body>
</html>
