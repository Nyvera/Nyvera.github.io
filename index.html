<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nyvera</title>
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Nyvera" />
  <link rel="manifest" href="manifest.json" />

  <!-- Glassmorphism Styling -->
  <style>
    :root {
      --bg: #0f1724;
      --muted: #94a3b8;
      --accent: #7c3aed;
    }
    html,body {
      height:100%;
      margin:0;
      font-family: Inter, system-ui, Segoe UI, Roboto, 'Helvetica Neue', Arial;
      color:#e6eef8;
      background:linear-gradient(180deg,#071129 0%,#00121a 100%);
    }
    .wrap {
      max-width:900px;
      margin:28px auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      height:95vh;
    }
    header {
      display:flex;
      gap:16px;
      align-items:center;
    }
    h1 {
      font-size:20px;
      margin:0;
    }

    /* Glass card */
    .card {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px;
      border-radius:20px;
      background:rgba(255,255,255,0.08);
      backdrop-filter: blur(18px) saturate(180%);
      -webkit-backdrop-filter: blur(18px) saturate(180%);
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 8px 24px rgba(0,0,0,0.4);
    }

    .controls {
      display:flex;
      gap:8px;
      margin-top:12px;
    }
    select,input[type=text],textarea {
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.06);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color:#e6eef8;
      transition:background 0.3s, border 0.3s;
    }
    select:focus,input[type=text]:focus,textarea:focus {
      border:1px solid var(--accent);
      outline:none;
      background:rgba(255,255,255,0.1);
    }
    button {
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      background:linear-gradient(135deg,var(--accent),#60a5fa);
      color:white;
      cursor:pointer;
      font-weight:500;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,0.5);
    }

    .progress {
      height:10px;
      background:rgba(255,255,255,0.08);
      border-radius:8px;
      margin-top:8px;
      overflow:hidden;
    }
    .progress > i {
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#7c3aed,#60a5fa);
    }

    .chat {
      flex:1;
      margin-top:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      padding:8px;
    }
    .msg {
      max-width:78%;
      padding:12px 14px;
      border-radius:14px;
      white-space:pre-wrap;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    .msg.user {
      align-self:flex-end;
      background:rgba(124,58,237,0.2);
      border:1px solid rgba(124,58,237,0.4);
      color:#e6e6ff;
    }
    .msg.ai {
      align-self:flex-start;
      background:rgba(15,23,36,0.5);
      border:1px solid rgba(255,255,255,0.15);
      color:#dcecff;
    }

    footer {
      display:flex;
      gap:8px;
      margin-top:12px;
    }
    .meta {
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
    }
    .help {
      margin-top:10px;
      color:#cfe8ff;
      font-size:13px;
    }
    .error {
      color:#ffb4b4;
      font-size:13px;
      margin-top:8px;
    }
    .small {
      font-size:12px;
      color:var(--muted);
    }
  </style>

  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:52px;height:52px;border-radius:16px;background:linear-gradient(90deg,#7c3aed,#60a5fa);display:flex;align-items:center;justify-content:center;color:#04233b;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.4);backdrop-filter:blur(8px)">AI</div>
      <div>
        <h1>Nyvera</h1>
        <div class="meta">The AI now maintains conversation history so it actually responds correctly.</div>
      </div>
    </header>

    <div class="card">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label style="color:var(--muted)">Model:</label>
        <select id="modelSelect"></select>
        <button id="loadBtn">Load model</button>
        <button id="refreshModelsBtn" title="Re-read built-in model list">Refresh</button>
        <div style="flex:1"></div>
        <div style="font-size:12px;color:var(--muted)">Status: <span id="status">idle</span></div>
      </div>

      <div class="progress" title="load progress"><i id="progressBar"></i></div>
      <div id="availableModels" class="help small"></div>
      <div id="errorBox" class="error" style="display:none"></div>

      <div class="chat" id="chat"></div>

      <footer>
        <textarea id="prompt" placeholder="Type a message..." ></textarea>
        <button id="sendBtn">Send</button>
      </footer>
    </div>
  </div>

  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    const { CreateMLCEngine, prebuiltAppConfig } = webllm;

    const statusEl = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const chatEl = document.getElementById('chat');
    const modelSelect = document.getElementById('modelSelect');
    const loadBtn = document.getElementById('loadBtn');
    const refreshBtn = document.getElementById('refreshModelsBtn');
    const sendBtn = document.getElementById('sendBtn');
    const promptEl = document.getElementById('prompt');
    const availableModelsEl = document.getElementById('availableModels');
    const errorBox = document.getElementById('errorBox');

    let engine = null;
    let messagesHistory = [];

    // --- Rendering helpers ---
    function renderAIText(text) {
      const processed = text.replace(/<think>(.*?)<\/think>/gs, "*$1*");
      const html = marked.parse(processed, { breaks: true });
      const container = document.createElement("div");
      container.innerHTML = html;
      container.querySelectorAll("pre code").forEach((el) => {
        hljs.highlightElement(el);
      });
      return container.innerHTML;
    }

    function appendMessage(who, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user' : 'ai');
      if (who === 'ai') {
        div.innerHTML = renderAIText(text);
      } else {
        div.innerText = text;
      }
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setStatus(s){ statusEl.innerText = s; }
    function setProgress(p){ progressBar.style.width = Math.max(0, Math.min(100, p)) + '%'; }

    function populateModelSelect(){
      modelSelect.innerHTML = '';
      errorBox.style.display = 'none';
      const list = (prebuiltAppConfig && prebuiltAppConfig.model_list) ? prebuiltAppConfig.model_list : [];
      if(list.length === 0){
        const fallback = [
          { id: 'SmolLM2-1.7B-Instruct-q0f16', label: 'SmolLM2-1.7B-Instruct' },
          { id: 'Llama-3.1-8B-Instruct', label: 'Llama-3.1-8B-Instruct' },
          { id: 'Qwen-1.5B', label: 'Qwen-1.5B' }
        ];
        fallback.forEach(f=>{
          const opt = document.createElement('option'); opt.value = f.id; opt.text=f.label||f.id; modelSelect.appendChild(opt);
        });
        availableModelsEl.innerText = 'Warning: no prebuilt models available.';
        return;
      }
      list.forEach(m=>{
        const id = m.model_id||m.model||m.name;
        if(!id) return;
        const opt=document.createElement('option');
        opt.value=id;
        opt.text=(m.short_name||m.name||id)+(m.vram_required_MB?` (VRAM ${m.vram_required_MB} MB)`: '');
        modelSelect.appendChild(opt);
      });
      availableModelsEl.innerText=`Detected ${list.length} built-in models.`;
    }

    async function loadModel(){
      const modelId = modelSelect.value;
      setStatus('initializing engine'); setProgress(0); errorBox.style.display='none';
      try{
        const initProgressCallback=(progress)=>{
          let frac=0;
          if(typeof progress==='number') frac=progress;
          else if(progress?.progress) frac=progress.progress;
          if(frac>1){ setProgress(frac); setStatus('loading model: '+Math.round(frac)+'%'); }
          else{ setProgress(frac*100); setStatus('loading model: '+Math.round(frac*100)+'%'); }
        };
        const opts = {initProgressCallback};
        if(prebuiltAppConfig) opts.appConfig=prebuiltAppConfig;
        engine = await CreateMLCEngine(modelId, opts);
        setStatus('ready ('+modelId+')'); setProgress(100);
      }catch(err){
        console.error(err); setStatus('error'); errorBox.style.display='block'; errorBox.innerText='Error loading model: '+(err?.message||err);
      }
    }

    async function sendMessage(){
      const text=promptEl.value.trim(); if(!text||!engine) return; promptEl.value=''; appendMessage('user', text);
      messagesHistory.push({role:'user', content:text});
      setStatus('generating...');

      const aiDiv=document.createElement('div'); aiDiv.className='msg ai'; aiDiv.innerHTML=''; chatEl.appendChild(aiDiv); chatEl.scrollTop=chatEl.scrollHeight;
      let partial='';
      try{
        const stream = await engine.chat.completions.create({messages:messagesHistory, temperature:0.7, stream:true});
        for await (const chunk of stream){
          const delta=chunk?.choices?.[0]?.delta?.content||'';
          if(delta){
            partial+=delta;
            aiDiv.innerHTML=renderAIText(partial);
            chatEl.scrollTop=chatEl.scrollHeight;
          }
        }
        messagesHistory.push({role:'assistant', content:partial});
        setStatus('ready');
      }catch(err){
        console.error(err); appendMessage('ai','Error: '+(err?.message||err)); setStatus('error');
      }
    }

    loadBtn.addEventListener('click', loadModel);
    sendBtn.addEventListener('click', sendMessage);
    refreshBtn.addEventListener('click', populateModelSelect);
    promptEl.addEventListener('keydown', e=>{if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)) sendMessage();});

    if(!('gpu' in navigator)) setStatus('WARNING: WebGPU not available');
    populateModelSelect();

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .then(reg => console.log("SW registered:", reg.scope))
          .catch(err => console.error("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
