<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrisimAI</title>
<link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; background:#0f1724; color:#e6eef8; }
#chat-history::-webkit-scrollbar { width: 8px; }
#chat-history::-webkit-scrollbar-track { background: #1e293b; }
#chat-history::-webkit-scrollbar-thumb { background-color: #3b82f6; border-radius: 4px; }
textarea { resize:none; }
.msg { max-width:75%; padding:10px; border-radius:12px; white-space:pre-wrap; word-wrap:break-word; }
.msg.user { align-self:flex-end; background:linear-gradient(180deg,#1d4ed8,#3b82f6); color:#fff; }
.msg.ai { align-self:flex-start; background:linear-gradient(180deg,#1e293b,#0f1724); border:1px solid rgba(255,255,255,0.05); color:#dcecff; }
.timestamp { font-size:10px; color:#94a3b8; margin-top:2px; text-align:right; }
.progress { height:10px; background:rgba(255,255,255,0.1); border-radius:8px; margin-top:4px; overflow:hidden; }
.progress > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#3b82f6,#60a5fa); }
</style>
</head>

<body class="flex h-screen">
<!-- Sidebar -->
<aside class="w-64 bg-gray-900 p-4 flex flex-col justify-between">
    <div>
        <h1 class="text-2xl font-bold mb-4 text-white">PrisimAI</h1>
        <label class="text-gray-400">Select Model</label>
        <select id="model-selector" class="w-full p-2 rounded-lg mt-2 bg-gray-800 text-white border border-gray-700"></select>
        <button id="load-btn" class="w-full mt-2 p-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition">Load Model</button>
        <div class="progress mt-2"><i id="progress-bar"></i></div>
        <div class="text-sm text-gray-400 mt-1">Load: <span id="progress-text">0%</span></div>
        <button id="new-chat-btn" class="w-full mt-4 p-2 rounded-lg bg-gray-700 hover:bg-gray-600">+ New Chat</button>
    </div>
</aside>

<main class="flex-1 flex flex-col">
    <div id="chat-history" class="flex-1 flex flex-col p-4 space-y-2 overflow-y-auto"></div>
    <div class="p-4 bg-gray-800 flex gap-2">
        <textarea id="chat-input" placeholder="Type a message..." rows="2" class="flex-1 p-2 rounded-lg bg-gray-700 text-white border border-gray-600"></textarea>
        <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 p-2 rounded-lg">Send</button>
    </div>
</main>

<script type="module">
import * as webllm from "https://esm.run/@mlc-ai/web-llm";
const { CreateMLCEngine, prebuiltAppConfig } = webllm;

const chatHistory = document.getElementById('chat-history');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const modelSelector = document.getElementById('model-selector');
const loadBtn = document.getElementById('load-btn');
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');
const newChatBtn = document.getElementById('new-chat-btn');

let engine = null;
let messagesHistory = [];

// --- UI ---
function addMessage(text, role){
    const div = document.createElement('div');
    div.className = 'msg ' + (role==='user'?'user':'ai');
    div.innerText = text;

    const time = document.createElement('div');
    time.className='timestamp';
    time.innerText=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

    div.appendChild(time);
    chatHistory.appendChild(div);
    chatHistory.scrollTop = chatHistory.scrollHeight;

    if(role==='user') messagesHistory.push({role, content:text});
}

// --- Progress ---
function setProgress(percent){
    progressBar.style.width = percent + '%';
    progressText.innerText = Math.round(percent)+'%';
}

// --- WebLLM ---
function populateModelSelect(){
    modelSelector.innerHTML='';
    const list = prebuiltAppConfig?.model_list || [];
    if(list.length===0){
        const fallback=[{id:'SmolLM2-1.7B-Instruct-q0f16',label:'SmolLM2-1.7B-Instruct'}];
        fallback.forEach(f=>{ const opt=document.createElement('option'); opt.value=f.id; opt.text=f.label||f.id; modelSelector.appendChild(opt);});
        return;
    }
    list.forEach(m=>{
        const id = m.model_id||m.model||m.name;
        if(!id) return;
        const opt=document.createElement('option'); opt.value=id; opt.text=m.short_name||m.name||id;
        modelSelector.appendChild(opt);
    });
}

async function loadModel(){
    const modelId = modelSelector.value;
    setProgress(0);
    try{
        engine = await CreateMLCEngine(modelId,{
            appConfig: prebuiltAppConfig,
            initProgressCallback: p=>{
                if(typeof p==='number') setProgress(p*100);
            }
        });
        setProgress(100);
        alert('Model loaded: '+modelId);
    }catch(err){
        console.error(err); alert('Error loading model: '+err.message);
    }
}

async function handleChat(){
    const text = chatInput.value.trim();
    if(!text || !engine) return;
    chatInput.value='';
    addMessage(text,'user');

    const aiDiv = document.createElement('div');
    aiDiv.className='msg ai'; aiDiv.innerText='...';
    const time = document.createElement('div'); time.className='timestamp'; time.innerText=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    aiDiv.appendChild(time);
    chatHistory.appendChild(aiDiv);
    chatHistory.scrollTop=chatHistory.scrollHeight;

    let partial='';
    try{
        const stream = await engine.chat.completions.create({messages:messagesHistory,temperature:0.7,stream:true});
        for await(const chunk of stream){
            const delta = chunk?.choices?.[0]?.delta?.content || '';
            if(delta){ partial+=delta; aiDiv.firstChild.nodeValue=partial; chatHistory.scrollTop=chatHistory.scrollHeight;}
        }
        messagesHistory.push({role:'assistant',content:partial});
    }catch(err){
        console.error(err);
        aiDiv.firstChild.nodeValue='Error: '+(err?.message||err);
    }
}

// --- Events ---
sendBtn.addEventListener('click',handleChat);
chatInput.addEventListener('keydown',e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleChat(); }
});
newChatBtn.addEventListener('click',()=>{ chatHistory.innerHTML=''; messagesHistory=[]; });
loadBtn.addEventListener('click',loadModel);

populateModelSelect();

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js', { scope: '/' })
                .then((registration) => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch((error) => {
                    console.error('Service Worker registration failed:', error);
                });
        });
    }
</script>
</body>
</html>
