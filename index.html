<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrisimAI Offline Chat</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; }
#chat-history::-webkit-scrollbar { width: 8px; }
#chat-history::-webkit-scrollbar-track { background: #f1f5f9; }
#chat-history::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

@keyframes bounce-dot {
    0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}
}
.bounce-dot{animation:bounce-dot 1.4s infinite ease-in-out both;}
</style>
</head>

<body class="bg-gray-100 text-gray-800 flex h-screen overflow-hidden">

<!-- Sidebar -->
<aside class="w-64 bg-gray-50 border-r border-gray-200 flex-shrink-0 flex flex-col justify-between p-4 sm:flex">
    <div class="space-y-4">
        <div class="flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5a6 6 0 1 0-12 0v1.5a6 6 0 0 0 6 6zM12 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
            </svg>
            <h1 class="text-xl font-bold text-gray-900">PrisimAI Offline</h1>
        </div>
        <button id="new-chat-btn" class="w-full p-2 rounded-lg bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition duration-200 text-center">+ New Chat</button>
        <div class="space-y-2">
            <label for="model-selector" class="text-sm font-medium text-gray-700">Select Model</label>
            <select id="model-selector" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
        </div>
    </div>
    <div class="mt-4 flex items-center space-x-2 p-2 hover:bg-gray-200 rounded-lg transition duration-200">
        <img src="https://placehold.co/32x32" alt="Profile" class="w-8 h-8 rounded-full">
        <div>
            <div class="font-medium text-gray-900">CJ</div>
            <div class="text-sm text-gray-500">7th Grade</div>
        </div>
    </div>
</aside>

<!-- Main Content -->
<main class="flex-1 flex flex-col relative">
    <div class="flex-1 flex flex-col justify-between" id="chat-container">
        <div id="chat-area" class="flex-1 relative">
            <div id="welcome-message" class="absolute inset-0 flex flex-col justify-center items-center text-center p-8 space-y-4 text-gray-500">
                <h2 class="text-2xl font-bold text-gray-800">Hello there, CJ!</h2>
                <p class="text-lg">Try typing something in the box below. Press Ctrl+Enter to send.</p>
            </div>
            <div id="chat-history" class="absolute inset-0 overflow-y-auto p-8 space-y-4 hidden"></div>
            <div class="absolute bottom-0 inset-x-0 p-4 bg-white border-t border-gray-200">
                <form id="chat-form" class="flex items-end space-x-4">
                    <textarea id="chat-input" placeholder="Message PrisimAI..." rows="1" class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                    <button type="submit" class="p-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-200">Send</button>
                </form>
            </div>
        </div>
    </main>

<script type="module">
import * as webllm from "https://esm.run/@mlc-ai/web-llm";
const { CreateMLCEngine, prebuiltAppConfig } = webllm;

const chatHistory = document.getElementById('chat-history');
const chatInput = document.getElementById('chat-input');
const chatForm = document.getElementById('chat-form');
const welcomeMessage = document.getElementById('welcome-message');
const newChatBtn = document.getElementById('new-chat-btn');
const modelSelector = document.getElementById('model-selector');

let engine = null;
let messagesHistory = [];

// --- UI Functions ---
function addMessage(text, role){
    welcomeMessage.classList.add('hidden');
    chatHistory.classList.remove('hidden');
    const div = document.createElement('div');
    div.className = 'flex mb-4 ' + (role==='user'?'justify-end':'justify-start');
    div.innerHTML = `<div class="p-4 rounded-xl ${role==='user'?'bg-blue-500 text-white':'bg-gray-200 text-gray-800'}" style="white-space:pre-wrap; max-width:80%;">${text}</div>`;
    chatHistory.appendChild(div);
    chatHistory.scrollTop = chatHistory.scrollHeight;
    messagesHistory.push({role, content:text});
}

// --- WebLLM Functions ---
function populateModelSelect(){
    modelSelector.innerHTML='';
    const list = (prebuiltAppConfig && prebuiltAppConfig.model_list) ? prebuiltAppConfig.model_list : [];
    if(list.length===0){
        const fallback=[{id:'SmolLM2-1.7B-Instruct-q0f16',label:'SmolLM2-1.7B-Instruct'}];
        fallback.forEach(f=>{
            const opt=document.createElement('option');
            opt.value=f.id; opt.text=f.label||f.id; modelSelector.appendChild(opt);
        });
        return;
    }
    list.forEach(m=>{
        const id = m.model_id||m.model||m.name;
        if(!id) return;
        const opt=document.createElement('option');
        opt.value=id; opt.text=(m.short_name||m.name||id);
        modelSelector.appendChild(opt);
    });
}

async function loadModel(){
    const modelId = modelSelector.value;
    engine = await CreateMLCEngine(modelId,{appConfig:prebuiltAppConfig});
}

async function handleChat(){
    const text = chatInput.value.trim();
    if(!text || !engine) return;
    chatInput.value='';
    addMessage(text,'user');

    const aiDiv = document.createElement('div');
    aiDiv.className='flex mb-4 justify-start';
    aiDiv.innerHTML=`<div class="p-4 rounded-xl bg-gray-200 text-gray-800" style="white-space:pre-wrap; max-width:80%;">...</div>`;
    chatHistory.appendChild(aiDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;

    let partial = '';
    try{
        const stream = await engine.chat.completions.create({messages:messagesHistory,temperature:0.7,stream:true});
        for await (const chunk of stream){
            const delta=chunk?.choices?.[0]?.delta?.content||'';
            if(delta){ partial+=delta; aiDiv.querySelector('div').innerText=partial; chatHistory.scrollTop=chatHistory.scrollHeight; }
        }
        messagesHistory.push({role:'assistant',content:partial});
    }catch(err){
        console.error(err);
        aiDiv.querySelector('div').innerText='Error: '+(err?.message||err);
    }
}

chatForm.addEventListener('submit',e=>{e.preventDefault();handleChat();});
chatInput.addEventListener('input',()=>{chatInput.style.height='auto'; chatInput.style.height=chatInput.scrollHeight+'px';});
newChatBtn.addEventListener('click',()=>{chatHistory.innerHTML='';messagesHistory=[];welcomeMessage.classList.remove('hidden');chatHistory.classList.add('hidden');});

populateModelSelect();
</script>
</body>
</html>
