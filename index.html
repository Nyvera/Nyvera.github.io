<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PrismAI — Chat</title>
<style>
  * { box-sizing: border-box; }
  html,body { height:100%; margin:0; font-family:Inter,system-ui; background:#0f1724; color:#e6eef8; }
  .app { display:grid; grid-template-columns:auto 1fr; height:100vh; }
  .options { width:280px; background:#121e2d; padding:20px; border-right:1px solid rgba(255,255,255,0.05); overflow:auto; }
  .options h2 { font-size:18px; margin-bottom:12px; color:#9fb5d6; }
  .options label { display:block; margin-top:10px; font-size:14px; }
  .options input, .options select { width:100%; margin-top:4px; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background:#0c1420; color:#dcebf8; }
  .options button { margin-top:16px; width:100%; padding:10px; font-size:14px; border:none; border-radius:6px; background:linear-gradient(90deg,#7c5cff,#3ad0ff); color:#051425; cursor:pointer; }
  .options button:disabled { opacity:0.5; cursor:not-allowed; }

  .chat { display:flex; flex-direction:column; }
  .topbar { padding:16px; font-size:20px; font-weight:600; border-bottom:1px solid rgba(255,255,255,0.03); background:#071029; color:#f8fbff; }
  .messages { flex:1; padding:20px; overflow:auto; }
  .msg { margin-bottom:12px; }
  .msg.user { text-align:right; }
  .msg .bubble { display:inline-block; padding:10px 14px; border-radius:14px; max-width:70%; line-height:1.4; }
  .msg.user .bubble { background:#1b2940; border:1px solid rgba(255,255,255,0.03); }
  .msg.assist .bubble { background:#0b2736; border:1px solid rgba(255,255,255,0.04); }
  .input-area { display:flex; padding:12px; border-top:1px solid rgba(255,255,255,0.03); }
  .input-area [contenteditable] { flex:1; padding:10px; background:#071722; border-radius:8px; border:1px solid rgba(255,255,255,0.03); color:#dff0ff; max-height:150px; overflow:auto; }
  .input-area button { margin-left:10px; padding:10px 16px; background:linear-gradient(90deg,#7c5cff,#3ad0ff); border:none; border-radius:8px; color:#051425; cursor:pointer; }
</style>
</head>
<body>
<div class="app">
  <div class="options">
    <h2>⚙ PrismAI Settings</h2>
    <label for="modelSelect">Model</label>
    <select id="modelSelect"><option>Loading models...</option></select>
    <label for="systemPrompt">System prompt</label>
    <input type="text" id="systemPrompt" value="You are PrismAI, a little witty and concise.">
    <label for="maxTokens">Max tokens</label>
    <input type="number" id="maxTokens" value="800" min="50" step="50">
    <label for="streamToggle"><input type="checkbox" id="streamToggle" checked> Enable streaming</label>
    <button id="clearBtn">Clear Conversation</button>
  </div>
  <div class="chat">
    <div class="topbar">PrismAI</div>
    <div id="messages" class="messages"></div>
    <div class="input-area">
      <div id="input" contenteditable="true" placeholder="Type a message..."></div>
      <button id="sendBtn">Send →</button>
    </div>
  </div>
</div>

<script>
  const modelsUrl = 'https://text.pollinations.ai/models';
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const clearBtn = document.getElementById('clearBtn');
  const modelSelect = document.getElementById('modelSelect');
  const systemPromptEl = document.getElementById('systemPrompt');
  const maxTokensEl = document.getElementById('maxTokens');
  const streamToggle = document.getElementById('streamToggle');

  let history = [], sending = false;

  // Fetch models and populate the select
  fetch(modelsUrl)
    .then(res => res.text())
    .then(txt => {
      const lines = txt.split('\\n').filter(l => l.startsWith('Model:'));
      modelSelect.innerHTML = lines.map(l => {
        const model = l.split('Model:')[1].trim();
        return `<option value="${model}">${model}</option>`;
      }).join('');
    })
    .catch(err => {
      console.error('Model list fetch failed:', err);
      modelSelect.innerHTML = '<option value="openai">openai</option><option value="mistral">mistral</option>';
    });

  function appendMessage(role, text){
    const div = document.createElement('div');
    div.className = 'msg ' + (role==='user'?'user':'assist');
    const span = document.createElement('span');
    span.className = 'bubble';
    span.textContent = text;
    div.appendChild(span);
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function send(){
    if (sending) return;
    const txt = inputEl.innerText.trim(); if (!txt) return;
    sending = true; sendBtn.disabled = true;
    appendMessage('user', txt);
    history.push({role:'user', content:txt});
    inputEl.innerText = '';

    const payload = {
      model: modelSelect.value,
      messages: [{role:'system', content:systemPromptEl.value}, ...history],
      max_tokens: +maxTokensEl.value,
      stream: streamToggle.checked
    };

    const url = 'https://text.pollinations.ai/openai';
    appendMessage('assist', '…'); // placeholder

    try {
      if (payload.stream) {
        const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json','Accept':'text/event-stream'}, body:JSON.stringify(payload)});
        const reader = res.body.getReader(), decoder = new TextDecoder(), bubble = messagesEl.lastChild.querySelector('.bubble');
        let buffer = '';
        while(true) {
          const {done,value} = await reader.read(); if(done) break;
          buffer += decoder.decode(value, {stream:true});
          const parts = buffer.split('\\n\\n');
          buffer = parts.pop();
          for (const part of parts) {
            if (!part.startsWith('data: ')) continue;
            const data = part.slice(6);
            if (data === '[DONE]') break;
            try {
              const json = JSON.parse(data);
              const content = json.choices?.[0]?.delta?.content;
              if (content) bubble.textContent += content;
            } catch(e){}
          }
        }
        history.push({role:'assistant', content: bubble.textContent});
      } else {
        const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        const json = await res.json();
        const msg = json.choices?.[0]?.message?.content || '';
        messagesEl.lastChild.querySelector('.bubble').textContent = msg;
        history.push({role:'assistant', content:msg});
      }
    } catch(err) {
      console.error(err);
      messagesEl.lastChild.querySelector('.bubble').textContent = 'Error: ' + err.message;
      history.push({role:'assistant', content:'[Error] '+err.message});
    } finally {
      sending = false; sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener('click', send);
  inputEl.addEventListener('keydown', e => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
  clearBtn.addEventListener('click', () => { history=[]; messagesEl.innerHTML=''; });

  // Initial assistant greeting
  appendMessage('assist', 'Hey—I’m PrismAI. All systems in the options panel. Type something!');
  inputEl.focus();
</script>
</body>
</html>
